#!/usr/bin/env ruby

TASKS_FILE = ".gitodo"
TASKS_PATH = File.join [ ENV['HOME'], TASKS_FILE ]

def tasks_file(mode, &block)
  File.open(TASKS_PATH, mode, 0644) { |f| yield f }
end

def tasks
  tasks_file("r") { |f|
    f.readlines
  }
end

def add(task)
  tasks_file("a+") { |f|
    f.puts(task)
  }
end

def write_tasks(tasks)
  tasks_file("w+") { |f|
    tasks.each { |task|
      f.puts task
    }
  }
end

def rm(taskid)
  all_tasks = tasks
  all_tasks.delete_at(taskid)
  write_tasks(all_tasks)
end

def list
  tasks.each_with_index { |task, i| puts "#{i} #{task}" }
end

def top
  tasks[0]
end

def commit(task_id)
  message = tasks[task_id]
  rm task_id
  exec "git commit -am '#{message}'"
end

case ARGV[0]
  when "add"
    if ARGV[1]
      add ARGV[1]
      puts "Added task: #{ARGV[1]}"
    else
      puts "Not enough arguments."
      puts "usage: gitodo add PATH"
    end 
  when "rm"
    if ARGV[1]
      rm ARGV[1].to_i
    else
      puts "Not enough arguments."
      puts "usage: gitodo rm PATH"
    end 
  when "edit"
    puts "editing"
  when "list"
    list
  when "top"
    puts top
  when "commit"
    commit(ARGV[1].to_i)
  when nil
    puts "Type gitodo help' for usage." 
  else
    puts "Unknown command: #{ARGV[0]}"
    puts "Type gitodo help' for usage." 
end

